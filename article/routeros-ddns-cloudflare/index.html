<!DOCTYPE html><html lang="zh-CN"><head><!--Meta Information--><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="好听的音乐和电影，各种实用电脑与安卓软件、个人编程经验！"><!--BaiDu No Transformation--><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><!--SEO Spider Information--><meta name="description" content="在 RouterOS 添加一个脚本执行后将公网IPv4&#x2F;IPv6解析到指定域名，该脚本改自 github 的 viritt&#x2F;cloudflare_update.script 相比原版本增加IPv6解析以及双栈的支持。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4&#x2F;IPv6)">
<meta property="og:url" content="https://www.hscbook.com/article/routeros-ddns-cloudflare/index.html">
<meta property="og:site_name" content="HscBook.">
<meta property="og:description" content="在 RouterOS 添加一个脚本执行后将公网IPv4&#x2F;IPv6解析到指定域名，该脚本改自 github 的 viritt&#x2F;cloudflare_update.script 相比原版本增加IPv6解析以及双栈的支持。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-13T04:42:58.000Z">
<meta property="article:modified_time" content="2021-12-11T15:51:44.054Z">
<meta property="article:author" content="Hscpro">
<meta property="article:tag" content="RouterOS">
<meta property="article:tag" content="DDNS">
<meta property="article:tag" content="cloudflare">
<meta name="twitter:card" content="summary"><!-- HTML Title--><title>Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6) | HscBook.</title><!--CDN Static resource--><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=1.1.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><!--Analytics--><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6)</h1><a id="logo" href="/.">HscBook.</a><p class="description">互联网的技术大杂烩</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/hot/"><i class="fa fa-thumbs-up"> 热门</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="local-search-css" id="local-search-result" style="display: none;"></div><div class="content_container"><div class="post"><h1 class="post-title">Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6)</h1><div class="post-meta">2020-03-13<span> | </span><span class="category"><a href="/categories/code/">Code</a></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-eye"></i><span class="post-count" id="pv_write" style="margin-left: 4px;" data="article/routeros-ddns-cloudflare/index.html">0</span><span class="post-meta-item-text"> 阅读</span></span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.6k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 7</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/article/routeros-ddns-cloudflare/#container"><span>评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">前提条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%85%AC%E7%BD%91%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.</span> <span class="toc-text">确认正确的公网地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%89%8D%E6%96%B0%E5%BB%BA%E5%AD%90%E5%9F%9F%E5%90%8D"><span class="toc-number">1.2.</span> <span class="toc-text">提前新建子域名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%84%9A%E6%9C%AC"><span class="toc-number">2.</span> <span class="toc-text">建立脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%84%9A%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">配置脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92"><span class="toc-number">4.</span> <span class="toc-text">创建任务计划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#END"><span class="toc-number">5.</span> <span class="toc-text">END</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>在 RouterOS 添加一个脚本执行后将公网IPv4/IPv6解析到指定域名，该脚本改自 github 的 viritt/cloudflare_update.script 相比原版本增加IPv6解析以及双栈的支持。</p>
<span id="more"></span>
</blockquote>
<h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p><strong>注意：脚本是基于RouterOS v6.46.4 编写的，大于小于此版本都可能导致一些命令问题</strong></p>
<h3 id="确认正确的公网地址"><a href="#确认正确的公网地址" class="headerlink" title="确认正确的公网地址"></a>确认正确的公网地址</h3><p><strong>IPv4验证方法：</strong></p>
<p>脚本提取 (WinBox –&gt; IP –&gt; Address List) 内指定接口的IP地址进行解析</p>
<p>ROS终端运行：<code>/ip address get [/ip address find interface=接口名称] address</code></p>
<p><strong>IPv6验证方法：</strong></p>
<p>脚本提取 DHCPv6 Client 获取的 Prefix 并加上指定的IPv6后缀进行解析</p>
<p>ROS终端运行：<code>/ipv6 dhcp-client get [find interface=接口名称] status</code></p>
<p>查看读出的数据是否为公网地址，</p>
<h3 id="提前新建子域名"><a href="#提前新建子域名" class="headerlink" title="提前新建子域名"></a>提前新建子域名</h3><p>在 CloudFlare 新建需要解析的子域名，若需要解析IPv6<br>和双栈还需要建立IPv4同名子域名和单独子域名，单独子域名用于IPv6是否更新的判断</p>
<ol>
<li>ipv4.hscbook.com（A记录）</li>
<li>ipv4.hscbook.com（AAAA记录）</li>
<li>ipv6.hscbook.com（AAAA记录）</li>
</ol>
<h2 id="建立脚本"><a href="#建立脚本" class="headerlink" title="建立脚本"></a>建立脚本</h2><p>使用 WinBox 客户端连接至 RouterOS ；依次 System –&gt; Scripts 进入脚本列表，新建一个名为<code>DDNS_CloudFlare</code> 脚本，将下面内容复制粘贴。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#########################################################################</span></span><br><span class="line"><span class="comment">#         ==================================================            #</span></span><br><span class="line"><span class="comment">#         $ Mikrotik RouterOS update script for CloudFlare $            #</span></span><br><span class="line"><span class="comment">#         ==================================================            #</span></span><br><span class="line"><span class="comment">#              Credits for Samuel Tegenfeldt, CC BY-SA 3.0              #</span></span><br><span class="line"><span class="comment">#                        Modified by kiler129                           #</span></span><br><span class="line"><span class="comment">#                        Modified by viritt                             #</span></span><br><span class="line"><span class="comment">#                        Modified by hscpro                             #</span></span><br><span class="line"><span class="comment">#########################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################# 程序配置信息 #################</span></span><br><span class="line"><span class="comment">#调试信息 true/false</span></span><br><span class="line">:<span class="built_in">local</span> CFDebug <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="comment">#IPV4使用的接口</span></span><br><span class="line">:global WANInterface4 <span class="string">&quot;pppoe-out1&quot;</span>  </span><br><span class="line"><span class="comment">#IPV6使用的接口</span></span><br><span class="line">:global WANInterface6 <span class="string">&quot;pppoe-out1&quot;</span>  </span><br><span class="line"><span class="comment">#IPV6后缀（&quot;::&quot;解析到RouterOS;可填写局域网内LAN固定后缀解析到内网某个设备,）</span></span><br><span class="line">:<span class="built_in">local</span> LANipv6end <span class="string">&quot;:xxxx:xxxx:xxxx:xxxx&quot;</span></span><br><span class="line"><span class="comment">#TTL</span></span><br><span class="line">:<span class="built_in">local</span> CFttl <span class="string">&quot;120&quot;</span></span><br><span class="line"><span class="comment">#主域名</span></span><br><span class="line">:<span class="built_in">local</span> CFzone <span class="string">&quot;hscbook.com&quot;</span></span><br><span class="line"><span class="comment">#IPv4子域名</span></span><br><span class="line">:<span class="built_in">local</span> CFdomain <span class="string">&quot;ipv4.hscbook.com&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFdomainid <span class="string">&quot;087dxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"><span class="comment">#双栈IPv6域名ID</span></span><br><span class="line">:<span class="built_in">local</span> CFdomainid46 <span class="string">&quot;8adcxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"><span class="comment">#IPv6子域名 true/false</span></span><br><span class="line">:<span class="built_in">local</span> switchv6 <span class="string">&quot;true&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFdomain6 <span class="string">&quot;ipv6.hscbook.com&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFdomainid6 <span class="string">&quot;f100xxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"><span class="comment">#CloudFlare账号与APIKEY</span></span><br><span class="line">:<span class="built_in">local</span> CFemail <span class="string">&quot;xxxxx@xxxxxx.com&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFtkn <span class="string">&quot;101fbxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFzoneid <span class="string">&quot;c25abxxxxcxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################# 内部变量 #################</span></span><br><span class="line"><span class="comment">#ipv4</span></span><br><span class="line">:<span class="built_in">local</span> currentIP <span class="string">&quot;&quot;</span></span><br><span class="line">:<span class="built_in">local</span> resolvedIP <span class="string">&quot;&quot;</span></span><br><span class="line">:global WANip <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#ipv6</span></span><br><span class="line">:<span class="built_in">local</span> currentIP6 <span class="string">&quot;&quot;</span></span><br><span class="line">:<span class="built_in">local</span> resolvedIP6 <span class="string">&quot;&quot;</span></span><br><span class="line">:global WANip6 <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################# 解析和设置IP变量 #################</span></span><br><span class="line"><span class="comment">#获取公网IPv4</span></span><br><span class="line">:<span class="built_in">set</span> currentIP [/ip address get [/ip address find interface=<span class="variable">$WANInterface4</span> ] address];</span><br><span class="line">:<span class="built_in">set</span> WANip [:pick <span class="variable">$currentIP</span> 0 [:find <span class="variable">$currentIP</span> <span class="string">&quot;/&quot;</span>]];</span><br><span class="line"><span class="comment">#获取域名IPv4</span></span><br><span class="line">:<span class="built_in">set</span> resolvedIP [:resolve <span class="variable">$CFdomain</span>];</span><br><span class="line"><span class="comment">#获取公网IPv6（DHCP方式）以及域名IPv6</span></span><br><span class="line">:<span class="keyword">if</span> ([/ipv6 dhcp-client get [find interface=<span class="variable">$WANInterface6</span>] status] = <span class="string">&quot;bound&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">    :<span class="keyword">if</span> ([/ipv6 dhcp-client get [find interface=<span class="variable">$WANInterface6</span> status=bound] prefix] != <span class="string">&quot;true&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">        :<span class="built_in">set</span> currentIP6 [/ipv6 dhcp-client get [find interface=<span class="variable">$WANInterface6</span> status=bound] prefix];</span><br><span class="line">        <span class="comment">#IPv6地址=公网IPv6前缀+设定的后缀</span></span><br><span class="line">        :<span class="built_in">set</span> WANip6 ([:pick <span class="variable">$currentIP6</span> 0 [:find <span class="variable">$currentIP6</span> <span class="string">&quot;::/&quot;</span>]] . <span class="variable">$LANipv6end</span>);</span><br><span class="line">        :<span class="built_in">set</span> resolvedIP6 [:resolve <span class="variable">$CFdomain6</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span>=&#123;</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 本机没有启用IPv6或配置不正确&quot;</span>)</span><br><span class="line">    :<span class="built_in">set</span> switchv6 <span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">################# 生成 CloudFlare API 链接 (v4) #################</span></span><br><span class="line"><span class="comment">#IPv4</span></span><br><span class="line">:<span class="built_in">local</span> CFurl4 <span class="string">&quot;https://api.cloudflare.com/client/v4/zones/&quot;</span></span><br><span class="line">:<span class="built_in">set</span> CFurl4 (<span class="variable">$CFurl4</span> . <span class="string">&quot;<span class="variable">$CFzoneid</span>/dns_records/<span class="variable">$CFdomainid</span>&quot;</span>);</span><br><span class="line"><span class="comment">#IPv6</span></span><br><span class="line">:<span class="built_in">local</span> CFurl46 <span class="string">&quot;https://api.cloudflare.com/client/v4/zones/&quot;</span></span><br><span class="line">:<span class="built_in">local</span> CFurl6 <span class="string">&quot;https://api.cloudflare.com/client/v4/zones/&quot;</span></span><br><span class="line">:<span class="keyword">if</span> (<span class="variable">$switchv6</span> = <span class="string">&quot;true&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">    :<span class="built_in">set</span> CFurl46 (<span class="variable">$CFurl46</span> . <span class="string">&quot;<span class="variable">$CFzoneid</span>/dns_records/<span class="variable">$CFdomainid46</span>&quot;</span>);</span><br><span class="line">    :<span class="built_in">set</span> CFurl6 (<span class="variable">$CFurl6</span> . <span class="string">&quot;<span class="variable">$CFzoneid</span>/dns_records/<span class="variable">$CFdomainid6</span>&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">################# 将调试信息写入日志 #################</span></span><br><span class="line">:<span class="keyword">if</span> (<span class="variable">$CFDebug</span> = <span class="string">&quot;true&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 调试模式打开&quot;</span>)</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 解析域名 <span class="variable">$CFdomain</span>&quot;</span>)</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 域名解析IPv4 <span class="variable">$resolvedIP</span>&quot;</span>)</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 当前公网IPv4 <span class="variable">$WANip</span>&quot;</span>)</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 使用的API地址v4 <span class="variable">$CFurl4</span>&amp;content=<span class="variable">$WANip</span>&quot;</span>)</span><br><span class="line">    :<span class="keyword">if</span> (<span class="variable">$switchv6</span> = <span class="string">&quot;true&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">        :<span class="built_in">log</span> info (<span class="string">&quot;CF: 域名解析IPv6 <span class="variable">$resolvedIP6</span>&quot;</span>)</span><br><span class="line">        :<span class="built_in">log</span> info (<span class="string">&quot;CF: 当前公网IPv6 <span class="variable">$WANip6</span>&quot;</span>)</span><br><span class="line">        :<span class="built_in">log</span> info (<span class="string">&quot;CF: 使用的API地址v6 <span class="variable">$CFurl6</span>&amp;content=<span class="variable">$WANip</span>&quot;</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    :put <span class="string">&quot;Get CFdomainid: curl -X GET \&quot;https://api.cloudflare.com/client/v4/zones/<span class="variable">$CFzoneid</span>/dns_records\&quot; -H \&quot;X-Auth-Email: <span class="variable">$CFemail</span>\&quot; -H \&quot;X-Auth-Key: <span class="variable">$CFtkn</span>\&quot; -H \&quot;Content-Type: application/json\&quot; | python -mjson.tool&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">################# IPv4比较和更新域名记录 #################</span></span><br><span class="line">:<span class="keyword">if</span> (<span class="variable">$resolvedIP</span> != <span class="variable">$WANip</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">    :<span class="built_in">log</span> info (<span class="string">&quot;CF: 正在更新 IPv4 解析地址 <span class="variable">$CFdomain</span> = <span class="variable">$WANip</span>&quot;</span>)</span><br><span class="line">    /tool fetch http-method=put mode=https url=<span class="string">&quot;<span class="variable">$CFurl4</span>&quot;</span> http-header-field=<span class="string">&quot;X-Auth-Email:<span class="variable">$CFemail</span>,X-Auth-Key:<span class="variable">$CFtkn</span>,content-type:application/json&quot;</span> as-value output=user http-data=<span class="string">&quot;&#123;\&quot;type\&quot;:\&quot;A\&quot;,\&quot;name\&quot;:\&quot;<span class="variable">$CFdomain</span>\&quot;,\&quot;content\&quot;:\&quot;<span class="variable">$WANip</span>\&quot;,\&quot;ttl\&quot;:<span class="variable">$CFttl</span>,\&quot;proxied\&quot;:false&#125;&quot;</span></span><br><span class="line">    <span class="comment">#/ip dns cache flush 执行间隔时大于TTS一倍可免于清理dns（TTS120-&gt;5m TTS300-&gt;10m）</span></span><br><span class="line">&#125; <span class="keyword">else</span>=&#123;</span><br><span class="line">    :<span class="built_in">log</span> info <span class="string">&quot;CF: IPv4公网地址与解析的地址匹配无需更新！&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">################# IPv6比较和更新域名记录 #################</span></span><br><span class="line">:<span class="keyword">if</span> (<span class="variable">$switchv6</span> = <span class="string">&quot;true&quot;</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">    :<span class="keyword">if</span> (<span class="variable">$resolvedIP6</span> != <span class="variable">$WANip6</span>) <span class="keyword">do</span>=&#123;</span><br><span class="line">        <span class="comment">#双栈</span></span><br><span class="line">        :<span class="built_in">log</span> info (<span class="string">&quot;CF: 正在更新 IPv6 解析地址 <span class="variable">$CFdomain</span> = <span class="variable">$WANip6</span>&quot;</span>)</span><br><span class="line">        /tool fetch http-method=put mode=https url=<span class="string">&quot;<span class="variable">$CFurl46</span>&quot;</span> http-header-field=<span class="string">&quot;X-Auth-Email:<span class="variable">$CFemail</span>,X-Auth-Key:<span class="variable">$CFtkn</span>,content-type:application/json&quot;</span> as-value output=user http-data=<span class="string">&quot;&#123;\&quot;type\&quot;:\&quot;AAAA\&quot;,\&quot;name\&quot;:\&quot;<span class="variable">$CFdomain</span>\&quot;,\&quot;content\&quot;:\&quot;<span class="variable">$WANip6</span>\&quot;,\&quot;ttl\&quot;:<span class="variable">$CFttl</span>,\&quot;proxied\&quot;:false&#125;&quot;</span></span><br><span class="line">        <span class="comment">#单IPv6域名</span></span><br><span class="line">        :<span class="built_in">log</span> info (<span class="string">&quot;CF: 正在更新 IPv6 解析地址 <span class="variable">$CFdomain6</span> = <span class="variable">$WANip6</span>&quot;</span>)</span><br><span class="line">        /tool fetch http-method=put mode=https url=<span class="string">&quot;<span class="variable">$CFurl6</span>&quot;</span> http-header-field=<span class="string">&quot;X-Auth-Email:<span class="variable">$CFemail</span>,X-Auth-Key:<span class="variable">$CFtkn</span>,content-type:application/json&quot;</span> as-value output=user http-data=<span class="string">&quot;&#123;\&quot;type\&quot;:\&quot;AAAA\&quot;,\&quot;name\&quot;:\&quot;<span class="variable">$CFdomain6</span>\&quot;,\&quot;content\&quot;:\&quot;<span class="variable">$WANip6</span>\&quot;,\&quot;ttl\&quot;:<span class="variable">$CFttl</span>,\&quot;proxied\&quot;:false&#125;&quot;</span></span><br><span class="line">        <span class="comment">#/ip dns cache flush</span></span><br><span class="line">    &#125; <span class="keyword">else</span>=&#123;</span><br><span class="line">        :<span class="built_in">log</span> info <span class="string">&quot;CF: IPv6公网地址与解析的地址匹配无需更新！&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置脚本"><a href="#配置脚本" class="headerlink" title="配置脚本"></a>配置脚本</h2><p>在 CloudFlare 域名主页的最下面 API 处</p>
<ol>
<li>将 Zone ID 填入脚本的 CFzoneid 变量</li>
<li>点击 Get your API token 获取 API token 填入脚本的 CFtkn 变量</li>
<li>将 CloudFlare 的邮箱账号填入 CFemail  变量</li>
</ol>
<p>根据三项信息套入 <code>url -X GET \&quot;https://api.cloudflare.com/client/v4/zones/$CFzoneid/dns_records\&quot; -H \&quot;X-Auth-Email: $CFemail\&quot; -H \&quot;X-Auth-Key: $CFtkn\&quot; -H \&quot;Content-Type: application/json\&quot; | python -mjson.tool&quot;</code> 并在 linux 终端中运行可取得子域名的 CFid 并填入 CFdomainid 变量</p>
<p><strong>其他变量根据注释以实际情况自行修改后点击 Run Script 运行脚本测试，查看系统日志无报错即可</strong></p>
<h2 id="创建任务计划"><a href="#创建任务计划" class="headerlink" title="创建任务计划"></a>创建任务计划</h2><p>修改好脚本后使用 WinBox 客户端连接至 RouterOS ；依次 System –&gt; Scheduler进入任务计划列表新建一个任务计划间隔时间建议为 TTL 变量的两倍，内容为 <code>/system script run &quot;DDNS_CloudFlare&quot;;</code></p>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>参考文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://wiki.mikrotik.com/wiki/Main_Page">MikroTik Wiki</a></p>
<p>原脚本：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://gist.github.com/viritt/605173d0b9d8cce433be34539db9923f#file-cloudflare_update-script-L39">Automatic script for Mikrotik RouterOS updating record on CloudFlare.</a></p>
<p>获取 CFid 可使用 API 调试工具，例：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://postwoman.cn/index.do#/article/detail?projectId=help&moduleId=155032424248009000006&type=ARTICLE&id=155037947655301000051">Postwoman(ApiDebug)</a></p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6)</p><p><span>文章作者：</span>HscPro</p><p><span>发布时间：</span>2020-03-13</p><p><span>最后更新：</span>2021-12-11</p><p><span>原始链接：</span><a href="/article/routeros-ddns-cloudflare/">https://www.hscbook.com/article/routeros-ddns-cloudflare/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://www.hscbook.com/article/routeros-ddns-cloudflare/"></i></span></p><p><span>版权声明：</span>除非注明，本博文章均为原创，转载请以链接形式标明本文地址</p></div><br><script type="text/javascript" src="/js/share.js?v=1.1.0" async></script><a class="article-share-link" data-url="https://www.hscbook.com/article/routeros-ddns-cloudflare/" data-id="ckxiolt8b00160oos4wnleqsd" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACG0lEQVR42u3aS46DQAwFQO5/6cwJIM92MlLcxSpCBLp6YbU/1xVfr8fr7pmreE3+i4GBsZtRXWLy3+dnkvv52jAwMM5h3EWwu2ee7ySw5FvJ2jAwMDCS358Knc9vwMDAwOgF3Hn2jIGBgZEzqqEzT1CTr/xrLo6BgfGDjF5Y/J/fX+lvYGBg/BTjVbyq76k2Jl+tCwMDYzcjD3DVA1l+NIwS1GQ9GBgYSxl5QS0vh1VLZvlIx+0dDAyMAxjJUibFr95CCwMfGBgYBzB6S8+LcdUktsrDwMA4h5F8uDcQlm9ZDrhNYjEwMNYxJiMX+XLnh79CgxMDA2Mdo9durA5DzFukb9gYGBgHMEZHsWISmzcJkrCOgYFxAqM6TtELtcmmVAtttyvBwMBYx0hGTqsHu17prbodV743GBgYKxjVVmKVNH9PYdgCAwNjKaO3lK+PUHyqnoeBgbGIMUllJ2W4JBC/+RYGBsZqRq/F2CuT5S3JZFvLA2EYGBiLGL3CXLWElwfWQmsTAwPjGMY3DnCT5WJgYGAkQbOamuaBuNrIfLM2DAyMpYzeOEWvfJbvazl5xsDAWM2YdAkn42XVAlyycRgYGLsZk2bAJGTPhzkwMDBOY8wDX7WdOUliMTAwMHqf6ZXtPnaGxcDAwIhHMXqBu5pC3yaxGBgYqxlJEpsvtBo6q4dLDAyM0xiTc9fzoTCn5lszamRiYGD8HuMPS568Krl1FioAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/routeros/"><i class="fa fa-tag"></i>RouterOS</a><a href="/tags/ddns/"><i class="fa fa-tag"></i>DDNS</a><a href="/tags/cloudflare/"><i class="fa fa-tag"></i>cloudflare</a></div><div class="post-nav"><a class="pre" href="/article/routeros-firewall/">Mikrotik 的 RouterBoard 硬件产品默认防火墙规则</a><a class="next" href="/article/linux-google-analytics/">Nginx 结合又拍云反代理 Google Analytics 加速国内访问</a></div><div id="container"></div><link rel="stylesheet" href="/css/Artalk.css?v=2.1.4"><script src="/js/Artalk.js?v=2.1.4"></script><script>new Artalk({
  el: '#container',
  pageKey: 'https://www.hscbook.com/article/routeros-ddns-cloudflare/',
  pageTitle: 'Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6)',
  server: 'https://client.hscbook.com/api/',
  site: 'hscbook',
  reqTimeout: '30000',
  placeholder: '键入内容...',
  noComment: '此时无声胜有声',
  sendBtn: '发送评论'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/code/">Code</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/geek/">Geek</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">Hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">Share</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/let-s-encrypt/" style="font-size: 15px;">Let's Encrypt</a> <a href="/tags/https/" style="font-size: 15px;">HTTPS</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/code/" style="font-size: 15px;">code</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/html/" style="font-size: 15px;">html</a> <a href="/tags/wordpress/" style="font-size: 15px;">wordpress</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/gravatar/" style="font-size: 15px;">gravatar</a> <a href="/tags/cdn/" style="font-size: 15px;">cdn</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/helloworld/" style="font-size: 15px;">HelloWorld</a> <a href="/tags/gentie/" style="font-size: 15px;">gentie</a> <a href="/tags/comment/" style="font-size: 15px;">comment</a> <a href="/tags/isso/" style="font-size: 15px;">isso</a> <a href="/tags/install/" style="font-size: 15px;">install</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/analytics/" style="font-size: 15px;">Analytics</a> <a href="/tags/dropbox/" style="font-size: 15px;">dropbox</a> <a href="/tags/backups/" style="font-size: 15px;">backups</a> <a href="/tags/monit/" style="font-size: 15px;">monit</a> <a href="/tags/debian/" style="font-size: 15px;">debian</a> <a href="/tags/raspberrypi/" style="font-size: 15px;">RaspBerryPi</a> <a href="/tags/geek/" style="font-size: 15px;">Geek</a> <a href="/tags/aria2/" style="font-size: 15px;">Aria2</a> <a href="/tags/fm/" style="font-size: 15px;">FM</a> <a href="/tags/audio/" style="font-size: 15px;">audio</a> <a href="/tags/dlna/" style="font-size: 15px;">DLNA</a> <a href="/tags/airplay/" style="font-size: 15px;">AirPlay</a> <a href="/tags/neteasecloudmusic/" style="font-size: 15px;">NeteaseCloudMusic</a> <a href="/tags/seafile/" style="font-size: 15px;">seafile</a> <a href="/tags/cloud/" style="font-size: 15px;">Cloud</a> <a href="/tags/haproxy/" style="font-size: 15px;">HAProxy</a> <a href="/tags/routeros/" style="font-size: 15px;">RouterOS</a> <a href="/tags/ddns/" style="font-size: 15px;">DDNS</a> <a href="/tags/cloudflare/" style="font-size: 15px;">cloudflare</a> <a href="/tags/seahub/" style="font-size: 15px;">seahub</a> <a href="/tags/memcached/" style="font-size: 15px;">memcached</a> <a href="/tags/firewall/" style="font-size: 15px;">Firewall</a> <a href="/tags/cdn/" style="font-size: 15px;">CDN</a> <a href="/tags/realip/" style="font-size: 15px;">realip</a> <a href="/tags/wannacry/" style="font-size: 15px;">Wannacry</a> <a href="/tags/loophole/" style="font-size: 15px;">Loophole</a> <a href="/tags/patch/" style="font-size: 15px;">Patch</a> <a href="/tags/video/" style="font-size: 15px;">video</a> <a href="/tags/mov/" style="font-size: 15px;">mov</a> <a href="/tags/mv/" style="font-size: 15px;">mv</a> <a href="/tags/youtube/" style="font-size: 15px;">Youtube</a> <a href="/tags/bomba/" style="font-size: 15px;">BOMBA</a> <a href="/tags/lizi/" style="font-size: 15px;">励志</a> <a href="/tags/zhuanzai/" style="font-size: 15px;">转载</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/article/routeros-firewall/">Mikrotik 的 RouterBoard 硬件产品默认防火墙规则</a></li><li class="post-list-item"><a class="post-list-link" href="/article/routeros-ddns-cloudflare/">Mikrotik RouterOS 路由器 CloudFlare DDNS 动态解析脚本(IPv4/IPv6)</a></li><li class="post-list-item"><a class="post-list-link" href="/article/linux-google-analytics/">Nginx 结合又拍云反代理 Google Analytics 加速国内访问</a></li><li class="post-list-item"><a class="post-list-link" href="/article/raspberrypi-aria2/">树莓派Aria2不限速下载利器安装与配置全攻略</a></li><li class="post-list-item"><a class="post-list-link" href="/article/raspberrypi-cloudmusic/">树莓派音乐闹钟，定时播放网易云音乐每日推荐歌单歌曲及插播语音天气预报</a></li><li class="post-list-item"><a class="post-list-link" href="/article/code-autohttp/">免费 Let's Encrypt 证书申请、部署全攻略与自动续期教程</a></li><li class="post-list-item"><a class="post-list-link" href="/article/linux-backups/">一个合格的服务器自动备份案例，闭环备份机制出错邮件报警</a></li><li class="post-list-item"><a class="post-list-link" href="/article/servar-cloudflare/">Nginx如何在使用类似CloudFlare的CDN加速服务后还能正常获取客户端的真实IP地址</a></li><li class="post-list-item"><a class="post-list-link" href="/article/raspberrypi-seafile-conf/">树莓派海文SeaFile配置Nginx前端反代并启用HTTPS全攻略</a></li><li class="post-list-item"><a class="post-list-link" href="/article/raspberrypi-seafile/">树莓派自搭建家庭云储存服务，海文SeaFile安装全攻略</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">HscBook.</a> All rights reserved. Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></br>
<i class="fa fa-sitemap"></i><a target="_blank" href="/sitemap.xml"> Sitemap </a><i class="fa fa-paw"></i><a target="_blank" href="/baidusitemap.xml"> Baidumap </a><i class="fa fa-github"></i><a rel="nofollow" target="_blank" href="https://github.com/hscpro"> Github </a><i class="fa fa-rss"></i><a target="_blank" href="/atom.xml"> Really Simple Syndication</a></br><div><div class="github-badge"><a href="https://hexo.io" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hexo</span></a></div>
<div class="github-badge"><a href="https://github.com" target="_black" rel="nofollow"><span class="badge-subject">Service by</span><span class="badge-value bg-lightgray">Github</span></a></div>
<div class="github-badge"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" target="_black" rel="nofollow"><span class="badge-subject">LICENSE</span><span class="badge-value bg-red">BY-NC-ND</span></a></div>
</div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.1.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.1.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=1.1.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.1.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.1.0"></script><script type="application/javascript" src="/js/hits.js?v=1.1.0" async></script></div></body></html>